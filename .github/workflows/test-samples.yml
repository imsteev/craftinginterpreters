name: Test Sample Scripts

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-samples:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Compile Lox interpreter
      run: javac com/craftinginterpreters/lox/*.java

    - name: Run all sample scripts
      shell: bash
      run: |
        set +e  # Don't exit on error - we handle errors ourselves

        # ANSI color codes
        GREEN='\033[0;32m'
        RED='\033[0;31m'
        BLUE='\033[0;34m'
        YELLOW='\033[1;33m'
        NC='\033[0m' # No Color
        BOLD='\033[1m'

        # Statistics
        total_passed=0
        total_failed=0
        failed_scripts=()

        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "  LOX INTERPRETER - SAMPLE SCRIPTS TEST SUITE"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""

        # Function to run tests in a category
        run_category() {
          local category=$1
          local category_name=$2
          local passed=0
          local failed=0

          echo ""
          echo -e "${BOLD}${BLUE}┌─────────────────────────────────────────────────────┐${NC}"
          echo -e "${BOLD}${BLUE}│  ${category_name}${NC}"
          echo -e "${BOLD}${BLUE}└─────────────────────────────────────────────────────┘${NC}"
          echo ""

          for script in samples/$category/*.lox; do
            if [ ! -f "$script" ]; then
              continue
            fi

            filename=$(basename "$script")
            printf "  %-35s " "$filename"

            # Run the script and capture output
            if output=$(java com.craftinginterpreters.lox.Lox "$script" 2>&1); then
              echo -e "${GREEN}✓ PASS${NC}"
              if [ -n "$output" ]; then
                echo -e "    ${GREEN}Output: $output${NC}"
              fi
              passed=$((passed + 1))
            else
              echo -e "${RED}✗ FAIL${NC}"
              echo -e "    ${RED}Error: $output${NC}"
              failed=$((failed + 1))
              failed_scripts+=("$script")
            fi
          done

          # Category summary
          local total=$((passed + failed))
          echo ""
          echo -e "  ${BOLD}Category Summary:${NC} $passed/$total passed"

          if [ $failed -gt 0 ]; then
            echo -e "  ${RED}Failed: $failed${NC}"
          fi

          total_passed=$((total_passed + passed))
          total_failed=$((total_failed + failed))
        }

        # Run tests by category
        if [ -d "samples/basics" ]; then
          run_category "basics" "BASICS - Core Language Features"
        fi

        if [ -d "samples/functions" ]; then
          run_category "functions" "FUNCTIONS - Closures & Recursion"
        fi

        if [ -d "samples/classes" ]; then
          run_category "classes" "CLASSES - Object-Oriented Programming"
        fi

        # Final summary
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo -e "${BOLD}  TEST SUMMARY${NC}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

        total_tests=$((total_passed + total_failed))
        echo ""
        echo "  Total Tests:    $total_tests"
        echo -e "  ${GREEN}Passed:         $total_passed${NC}"

        if [ $total_failed -gt 0 ]; then
          echo -e "  ${RED}Failed:         $total_failed${NC}"
          echo ""
          echo -e "${RED}Failed Scripts:${NC}"
          for script in "${failed_scripts[@]}"; do
            echo "    • $script"
          done
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 1
        else
          echo ""
          echo -e "${GREEN}${BOLD}  ✓ All tests passed!${NC}"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 0
        fi
